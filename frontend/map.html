<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI-Powered Map | Incredible India</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #ff6700;
            --secondary-color: #046A38;
            --text-color: #333;
            --white-color: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 5%;
            background-color: var(--white-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            flex-shrink: 0;
            z-index: 1001;
            position: relative;
        }
        .navbar .logo { display: flex; align-items: center; gap: 0.75rem; text-decoration: none; }
        .navbar .logo img { width: 40px; }
        .navbar .logo h1 { font-size: 1.5rem; color: var(--primary-color); }
        .navbar nav { display: flex; align-items: center; gap: 1rem; }
        .navbar nav a { text-decoration: none; font-weight: 600; color: var(--text-color); }

        /* --- Language Selector CSS --- */
        .language-selector {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 1rem; /* Added margin */
        }
        #language-select {
            padding: 0.3rem 0.5rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-family: inherit;
            font-size: 0.8rem;
        }

        /* Hamburger menu */
        .menu-toggle {
            display: none;
            flex-direction: column;
            justify-content: space-between;
            width: 25px;
            height: 20px;
            cursor: pointer;
        }
        .menu-toggle span {
            display: block;
            height: 3px;
            background: var(--primary-color);
            border-radius: 2px;
             transition: all 0.3s ease-in-out; /* Added transition for animation */
        }
        /* Active state for hamburger */
         .menu-toggle.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
         .menu-toggle.active span:nth-child(2) { opacity: 0; }
         .menu-toggle.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }


        .main-content { display: flex; flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; z-index: 1; }

        .search-container { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; width: 500px; max-width: 90%; }
        #search-input { width: 100%; padding: 12px 20px; font-size: 1rem; border: none; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); padding-right: 45px; }
        #search-spinner { position: absolute; right: 15px; top: 13px; width: 20px; height: 20px; border: 3px solid #ccc; border-top: 3px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #details-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: 500px;
            max-width: 90%;
            height: 100%;
            background-color: var(--white-color);
            z-index: 1000;
            box-shadow: -5px 0 15px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.4s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        #details-panel.visible { transform: translateX(0); }
        #details-panel .panel-content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        #details-panel h2 { font-size: 1.8rem; color: var(--primary-color); margin-bottom: 1rem; }
        #panel-description { font-size: 0.95rem; color: #555; text-align: justify; line-height: 1.7; min-height: 100px; white-space: pre-wrap; }

        .blinking-cursor { font-weight: bold; animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { color: transparent; } 50% { color: var(--primary-color); } }

        .ai-buttons { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .ai-btn { flex: 1; padding: 8px; border: 1px solid var(--primary-color); border-radius: 50px; background: transparent; color: var(--primary-color); font-weight: 600; cursor: pointer; transition: background-color 0.2s, color 0.2s;}
        .ai-btn:hover { background-color: var(--primary-color); color: var(--white-color); }

        .info-section { margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1.5rem; }
        .weather-info { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        /* Icon styles removed */
        .weather-temp { font-size: 2rem; font-weight: 600; }
        .weather-desc { color: #777; }
        .climate-tips-list { list-style: none; padding-left: 0; margin-top: 1rem; }
        .climate-tips-list li { padding-left: 1.5rem; position: relative; margin-bottom: 0.5rem; color: #555; }
        .climate-tips-list li::before { content: '‚úì'; color: var(--secondary-color); position: absolute; left: 0; font-weight: bold; }

        #close-btn { position: absolute; top: 10px; right: 15px; font-size: 2rem; cursor: pointer; color: #aaa; }

        /* üì± Responsive Mobile */
        @media (max-width: 768px) {
            .navbar nav {
                position: absolute;
                top: 70px; /* Adjusted */
                right: 5%; /* Align to the right edge */
                background: var(--white-color);
                flex-direction: column;
                align-items: flex-start;
                width: auto; /* Adjust width as needed */
                min-width: 180px; /* Ensure enough width */
                padding: 1rem;
                display: none;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.15);
                z-index: 1000;
            }
            .navbar nav.show { display: flex; }
            /* Make selector and links full width in mobile nav */
            .navbar nav a, .navbar nav .language-selector {
                margin: 0.5rem 0;
                font-size: 0.9rem;
                width: 100%;
            }
            .navbar nav .language-selector {
                gap: 0.5rem;
                justify-content: space-between;
            }
            .navbar nav #language-select {
                font-size: 0.9rem;
                flex-grow: 1; /* Make select fill remaining space */
            }

            .menu-toggle { display: flex; }

            #details-panel { width: 100%; max-width: 100%; }
            .search-container { top: 10px; width: 90%; }
        }
    </style>
</head>
<body>
    <header class="navbar">
        <a href="index.html" class="logo">
            <img src="https://img.icons8.com/color/48/lotus.png" alt="Tourism Logo" />
            <h1 data-i18n="app-title">Incredible India</h1>
        </a>
        <div class="menu-toggle" id="menu-toggle">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <nav id="nav-links">
            <div class="language-selector">
                <label for="language-select" data-i18n="lang-label">Language:</label>
                <select id="language-select">
                    <option value="en">English</option>
                    <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
                    <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                    <option value="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)</option>
                    <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
                    <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
                    <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
                    <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                </select>
            </div>
            <a href="login.html" data-i18n="nav-home">Home</a>
            <a href="festivals.html" data-i18n="nav-festivals">Tourist Place Finder</a>
            <a href="plan.html" data-i18n="nav-planner">AI Trip Planner</a>
         </nav>
    </header>

    <main class="main-content">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search for any location in India..." data-i18n-placeholder="search-placeholder">
            <div id="search-spinner"></div>
        </div>
        <div id="map"></div>

        <aside id="details-panel">
            <span id="close-btn">&times;</span>
            <div class="panel-content">
                <h2 id="panel-title">Location Title</h2>
                <div id="panel-description"></div>
                <div class="ai-buttons">
                    <button class="ai-btn" data-question="Tell me a fun fact" data-i18n="btn-fun-fact">Fun Fact</button>
                    <button class="ai-btn" data-question="Describe the architecture" data-i18n="btn-architecture">Architecture</button>
                    <button class="ai-btn" data-question="Why is it famous?" data-i18n="btn-why-famous">Why Famous?</button>
                </div>
                <div class="info-section">
                    <h3 data-i18n="weather-title">Current Weather</h3>
                    <div class="weather-info">
                         <div>
                            <span id="weather-temp" class="weather-temp">--¬∞C</span>
                            <div id="weather-desc" class="weather-desc" data-i18n="weather-loading">Loading...</div>
                        </div>
                    </div>
                    <ul class="climate-tips-list" id="climate-tips-list"></ul>
                </div>
            </div>
        </aside>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const backendUrl = 'https://toursim-dy8l.onrender.com'; // Make sure this matches your backend

            // --- TRANSLATION SCRIPT ---
            const translations = {
              en: {
                'lang-label': 'Language:',
                'app-title': 'Incredible India',
                'nav-home': 'Home',
                'nav-planner': 'AI Trip Planner',
                'nav-festivals': 'Tourist Place Finder', // Updated Text
                'search-placeholder': 'Search for any location in India...',
                'btn-fun-fact': 'Fun Fact',
                'btn-architecture': 'Architecture',
                'btn-why-famous': 'Why Famous?',
                'weather-title': 'Current Weather',
                'weather-loading': 'Loading...',
                'weather-error': 'Could not load.',
                'ai-thinking': 'Thinking...',
                'ai-history-generating': 'Generating history...',
                'ai-error': 'Could not get an answer.',
                'title-map': 'AI-Powered Map | Incredible India'
              },
              hi: {
                'lang-label': '‡§≠‡§æ‡§∑‡§æ:',
                'app-title': '‡§Ö‡§§‡•Å‡§≤‡•ç‡§Ø ‡§≠‡§æ‡§∞‡§§',
                'nav-home': '‡§π‡•ã‡§Æ',
                'nav-planner': 'AI ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡§æ‡§∞',
                'nav-festivals': '‡§™‡§∞‡•ç‡§Ø‡§ü‡§ï ‡§∏‡•ç‡§•‡§≤ ‡§ñ‡•ã‡§ú‡§ï',
                'search-placeholder': '‡§≠‡§æ‡§∞‡§§ ‡§Æ‡•á‡§Ç ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•ã ‡§ñ‡•ã‡§ú‡•á‡§Ç...',
                'btn-fun-fact': '‡§∞‡•ã‡§ö‡§ï ‡§§‡§•‡•ç‡§Ø',
                'btn-architecture': '‡§µ‡§æ‡§∏‡•ç‡§§‡•Å‡§ï‡§≤‡§æ',
                'btn-why-famous': '‡§ï‡•ç‡§Ø‡•ã‡§Ç ‡§™‡•ç‡§∞‡§∏‡§ø‡§¶‡•ç‡§ß ‡§π‡•à?',
                'weather-title': '‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•å‡§∏‡§Æ',
                'weather-loading': '‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
                'weather-error': '‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§',
                'ai-thinking': '‡§∏‡•ã‡§ö ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å...',
                'ai-history-generating': '‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§¨‡§®‡§æ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å...',
                'ai-error': '‡§â‡§§‡•ç‡§§‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤ ‡§∏‡§ï‡§æ‡•§',
                'title-map': 'AI-‡§∏‡§Ç‡§ö‡§æ‡§≤‡§ø‡§§ ‡§®‡§ï‡•ç‡§∂‡§æ | ‡§Ö‡§§‡•Å‡§≤‡•ç‡§Ø ‡§≠‡§æ‡§∞‡§§'
              },
              ta: {
                'lang-label': '‡ÆÆ‡Øä‡Æ¥‡Æø:',
                'app-title': '‡Æ®‡ÆÆ‡Øç‡Æ™‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Ææ‡Æ§ ‡Æá‡Æ®‡Øç‡Æ§‡Æø‡ÆØ‡Ææ',
                'nav-home': '‡ÆÆ‡ØÅ‡Æï‡Æ™‡Øç‡Æ™‡ØÅ',
                'nav-planner': 'AI ‡Æ™‡ÆØ‡Æ£‡Æ§‡Øç ‡Æ§‡Æø‡Æü‡Øç‡Æü‡ÆÆ‡Æø‡Æü‡ØÅ‡Æ™‡Æµ‡Æ∞‡Øç',
                'nav-festivals': '‡Æö‡ØÅ‡Æ±‡Øç‡Æ±‡ØÅ‡Æ≤‡Ææ ‡Æá‡Æü ‡Æï‡Æ£‡Øç‡Æü‡ØÅ‡Æ™‡Æø‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Ææ‡Æ≥‡Æ∞‡Øç',
                'search-placeholder': '‡Æá‡Æ®‡Øç‡Æ§‡Æø‡ÆØ‡Ææ‡Æµ‡Æø‡Æ≤‡Øç ‡Æé‡Æ®‡Øç‡Æ§ ‡Æá‡Æü‡Æ§‡Øç‡Æ§‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Øá‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç...',
                'btn-fun-fact': '‡Æö‡ØÅ‡Æµ‡Ææ‡Æ∞‡Æ∏‡Øç‡ÆØ‡ÆÆ‡Ææ‡Æ© ‡Æâ‡Æ£‡Øç‡ÆÆ‡Øà',
                'btn-architecture': '‡Æï‡Æü‡Øç‡Æü‡Æø‡Æü‡Æï‡Øç‡Æï‡Æ≤‡Øà',
                'btn-why-famous': '‡Æè‡Æ©‡Øç ‡Æ™‡Æø‡Æ∞‡Æ™‡Æ≤‡ÆÆ‡Ææ‡Æ©‡Æ§‡ØÅ?',
                'weather-title': '‡Æ§‡Æ±‡Øç‡Æ™‡Øã‡Æ§‡Øà‡ÆØ ‡Æµ‡Ææ‡Æ©‡Æø‡Æ≤‡Øà',
                'weather-loading': '‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...',
                'weather-error': '‡Æè‡Æ±‡Øç‡Æ± ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.',
                'ai-thinking': '‡Æö‡Æø‡Æ®‡Øç‡Æ§‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç...',
                'ai-history-generating': '‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡Øç‡Æ±‡Øà ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç...',
                'ai-error': '‡Æ™‡Æ§‡Æø‡Æ≤‡Øç ‡Æ™‡ØÜ‡Æ± ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.',
                'title-map': 'AI-‡Æá‡ÆØ‡Æô‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æµ‡Æ∞‡Øà‡Æ™‡Æü‡ÆÆ‡Øç | ‡Æ®‡ÆÆ‡Øç‡Æ™‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Ææ‡Æ§ ‡Æá‡Æ®‡Øç‡Æ§‡Æø‡ÆØ‡Ææ'
              },
              ml: {
                'lang-label': '‡¥≠‡¥æ‡¥∑:',
                'app-title': '‡¥Ö‡¥µ‡¥ø‡¥∂‡µç‡¥µ‡¥∏‡¥®‡µÄ‡¥Ø‡¥Æ‡¥æ‡¥Ø ‡¥á‡¥®‡µç‡¥§‡µç‡¥Ø',
                'nav-home': '‡¥π‡µã‡¥Ç',
                'nav-planner': 'AI ‡¥ü‡µç‡¥∞‡¥ø‡¥™‡µç‡¥™‡µç ‡¥™‡µç‡¥≤‡¥æ‡¥®‡µº',
                'nav-festivals': '‡¥ü‡µÇ‡¥±‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥™‡µç‡¥≤‡µá‡¥∏‡µç ‡¥´‡µà‡µª‡¥°‡µº',
                'search-placeholder': '‡¥á‡¥®‡µç‡¥§‡µç‡¥Ø‡¥Ø‡¥ø‡µΩ ‡¥é‡¥µ‡¥ø‡¥ü‡µÜ‡¥Ø‡µÅ‡¥Ç ‡¥§‡¥ø‡¥∞‡¥Ø‡µÅ‡¥ï...',
                'btn-fun-fact': '‡¥∞‡¥∏‡¥ï‡¥∞‡¥Æ‡¥æ‡¥Ø ‡¥µ‡¥∏‡µç‡¥§‡µÅ‡¥§',
                'btn-architecture': '‡¥µ‡¥æ‡¥∏‡µç‡¥§‡µÅ‡¥µ‡¥ø‡¥¶‡µç‡¥Ø',
                'btn-why-famous': '‡¥é‡¥®‡µç‡¥§‡µÅ‡¥ï‡µä‡¥£‡µç‡¥ü‡µç ‡¥™‡µç‡¥∞‡¥∂‡¥∏‡µç‡¥§‡¥Ç?',
                'weather-title': '‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÜ ‡¥ï‡¥æ‡¥≤‡¥æ‡¥µ‡¥∏‡µç‡¥•',
                'weather-loading': '‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ...',
                'weather-error': '‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª ‡¥ï‡¥¥‡¥ø‡¥û‡µç‡¥û‡¥ø‡¥≤‡µç‡¥≤.',
                'ai-thinking': '‡¥ö‡¥ø‡¥®‡µç‡¥§‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ...',
                'ai-history-generating': '‡¥ö‡¥∞‡¥ø‡¥§‡µç‡¥∞‡¥Ç ‡¥∏‡µÉ‡¥∑‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ...',
                'ai-error': '‡¥â‡¥§‡µç‡¥§‡¥∞‡¥Ç ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥≤‡µç‡¥≤.',
                'title-map': 'AI-‡¥™‡¥µ‡µº‡¥°‡µç ‡¥Æ‡¥æ‡¥™‡µç‡¥™‡µç | ‡¥Ö‡¥µ‡¥ø‡¥∂‡µç‡¥µ‡¥∏‡¥®‡µÄ‡¥Ø‡¥Æ‡¥æ‡¥Ø ‡¥á‡¥®‡µç‡¥§‡µç‡¥Ø'
              },
              te: {
                'lang-label': '‡∞≠‡∞æ‡∞∑:',
                'app-title': '‡∞Ö‡∞µ‡∞ø‡∞∂‡±ç‡∞µ‡∞∏‡∞®‡±Ä‡∞Ø‡∞Æ‡±à‡∞® ‡∞≠‡∞æ‡∞∞‡∞§‡∞¶‡±á‡∞∂‡∞Ç',
                'nav-home': '‡∞π‡±ã‡∞Æ‡±ç',
                'nav-planner': 'AI ‡∞ü‡±ç‡∞∞‡∞ø‡∞™‡±ç ‡∞™‡±ç‡∞≤‡∞æ‡∞®‡∞∞‡±ç',
                'nav-festivals': '‡∞™‡∞∞‡±ç‡∞Ø‡∞æ‡∞ü‡∞ï ‡∞∏‡±ç‡∞•‡∞≤ ‡∞´‡±à‡∞Ç‡∞°‡∞∞‡±ç',
                'search-placeholder': '‡∞≠‡∞æ‡∞∞‡∞§‡∞¶‡±á‡∞∂‡∞Ç‡∞≤‡±ã ‡∞è‡∞¶‡±à‡∞®‡∞æ ‡∞™‡±ç‡∞∞‡∞¶‡±á‡∞∂‡∞Ç ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞∂‡±ã‡∞ß‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø...',
                'btn-fun-fact': '‡∞∏‡∞∞‡∞¶‡∞æ ‡∞µ‡∞æ‡∞∏‡±ç‡∞§‡∞µ‡∞Ç',
                'btn-architecture': '‡∞Ü‡∞∞‡±ç‡∞ï‡∞ø‡∞ü‡±Ü‡∞ï‡±ç‡∞ö‡∞∞‡±ç',
                'btn-why-famous': '‡∞é‡∞Ç‡∞¶‡±Å‡∞ï‡±Å ‡∞™‡±ç‡∞∞‡∞∏‡∞ø‡∞¶‡±ç‡∞ß‡∞ø?',
                'weather-title': '‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§ ‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç',
                'weather-loading': '‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...',
                'weather-error': '‡∞≤‡±ã‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞°‡∞Ç ‡∞∏‡∞æ‡∞ß‡±ç‡∞Ø‡∞Ç ‡∞ï‡∞æ‡∞≤‡±á‡∞¶‡±Å.',
                'ai-thinking': '‡∞Ü‡∞≤‡±ã‡∞ö‡∞ø‡∞∏‡±ç‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞®‡±Å...',
                'ai-history-generating': '‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞‡∞®‡±Å ‡∞∏‡±É‡∞∑‡±ç‡∞ü‡∞ø‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...',
                'ai-error': '‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞Ç ‡∞™‡±ä‡∞Ç‡∞¶‡∞≤‡±á‡∞ï‡∞™‡±ã‡∞Ø‡∞æ‡∞®‡±Å.',
                'title-map': 'AI-‡∞Ü‡∞ß‡∞æ‡∞∞‡∞ø‡∞§ ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞™‡±ç | ‡∞Ö‡∞µ‡∞ø‡∞∂‡±ç‡∞µ‡∞∏‡∞®‡±Ä‡∞Ø‡∞Æ‡±à‡∞® ‡∞≠‡∞æ‡∞∞‡∞§‡∞¶‡±á‡∞∂‡∞Ç'
              },
              kn: {
                'lang-label': '‡≤≠‡≤æ‡≤∑‡≥Ü:',
                'app-title': '‡≤Ö‡≤¶‡≥ç‡≤≠‡≥Å‡≤§ ‡≤≠‡≤æ‡≤∞‡≤§',
                'nav-home': '‡≤Æ‡≥Å‡≤ñ‡≤™‡≥Å‡≤ü',
                'nav-planner': 'AI ‡≤ü‡≥ç‡≤∞‡≤ø‡≤™‡≥ç ‡≤™‡≥ç‡≤≤‡≤æ‡≤®‡≤∞‡≥ç',
                'nav-festivals': '‡≤™‡≥ç‡≤∞‡≤µ‡≤æ‡≤∏‡≤ø ‡≤∏‡≥ç‡≤•‡≤≥ ‡≤∂‡≥ã‡≤ß‡≤ï',
                'search-placeholder': '‡≤≠‡≤æ‡≤∞‡≤§‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø ‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤∏‡≥ç‡≤•‡≤≥‡≤ï‡≥ç‡≤ï‡≤æ‡≤ó‡≤ø ‡≤π‡≥Å‡≤°‡≥Å‡≤ï‡≤ø...',
                'btn-fun-fact': '‡≤Æ‡≥ã‡≤ú‡≤ø‡≤® ‡≤∏‡≤Ç‡≤ó‡≤§‡≤ø',
                'btn-architecture': '‡≤µ‡≤æ‡≤∏‡≥ç‡≤§‡≥Å‡≤∂‡≤ø‡≤≤‡≥ç‡≤™',
                'btn-why-famous': '‡≤è‡≤ï‡≥Ü ‡≤™‡≥ç‡≤∞‡≤∏‡≤ø‡≤¶‡≥ç‡≤ß?',
                'weather-title': '‡≤™‡≥ç‡≤∞‡≤∏‡≥ç‡≤§‡≥Å‡≤§ ‡≤π‡≤µ‡≤æ‡≤Æ‡≤æ‡≤®',
                'weather-loading': '‡≤≤‡≥ã‡≤°‡≥ç ‡≤Ü‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...',
                'weather-error': '‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤∏‡≤æ‡≤ß‡≥ç‡≤Ø‡≤µ‡≤æ‡≤ó‡≤≤‡≤ø‡≤≤‡≥ç‡≤≤.',
                'ai-thinking': '‡≤Ø‡≥ã‡≤ö‡≤ø‡≤∏‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...',
                'ai-history-generating': '‡≤á‡≤§‡≤ø‡≤π‡≤æ‡≤∏‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤∞‡≤ö‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...',
                'ai-error': '‡≤â‡≤§‡≥ç‡≤§‡≤∞‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤™‡≤°‡≥Ü‡≤Ø‡≤≤‡≥Å ‡≤∏‡≤æ‡≤ß‡≥ç‡≤Ø‡≤µ‡≤æ‡≤ó‡≤≤‡≤ø‡≤≤‡≥ç‡≤≤.',
                'title-map': 'AI-‡≤ö‡≤æ‡≤≤‡≤ø‡≤§ ‡≤®‡≤ï‡≥ç‡≤∑‡≥Ü | ‡≤Ö‡≤¶‡≥ç‡≤≠‡≥Å‡≤§ ‡≤≠‡≤æ‡≤∞‡≤§'
              },
              bn: {
                'lang-label': '‡¶≠‡¶æ‡¶∑‡¶æ:',
                'app-title': '‡¶Ö‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶Ø ‡¶≠‡¶æ‡¶∞‡¶§',
                'nav-home': '‡¶π‡ßã‡¶Æ',
                'nav-planner': 'AI ‡¶ü‡ßç‡¶∞‡¶ø‡¶™ ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞',
                'nav-festivals': '‡¶™‡¶∞‡ßç‡¶Ø‡¶ü‡¶® ‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶°‡¶æ‡¶∞',
                'search-placeholder': '‡¶≠‡¶æ‡¶∞‡¶§‡ßá‡¶∞ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®...',
                'btn-fun-fact': '‡¶Æ‡¶ú‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø',
                'btn-architecture': '‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶§‡ßç‡¶Ø',
                'btn-why-famous': '‡¶ï‡ßá‡¶® ‡¶¨‡¶ø‡¶ñ‡ßç‡¶Ø‡¶æ‡¶§?',
                'weather-title': '‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ',
                'weather-loading': '‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...',
                'weather-error': '‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§',
                'ai-thinking': '‡¶≠‡¶æ‡¶¨‡¶õ‡¶ø...',
                'ai-history-generating': '‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶õ‡¶ø...',
                'ai-error': '‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§',
                'title-map': 'AI-‡¶ö‡¶æ‡¶≤‡¶ø‡¶§ ‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞ | ‡¶Ö‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶Ø ‡¶≠‡¶æ‡¶∞‡¶§'
              },
              mr: {
                'lang-label': '‡§≠‡§æ‡§∑‡§æ:',
                'app-title': '‡§Ö‡§§‡•Å‡§≤‡•ç‡§Ø ‡§≠‡§æ‡§∞‡§§',
                'nav-home': '‡§π‡•ã‡§Æ',
                'nav-planner': 'AI ‡§ü‡•ç‡§∞‡§ø‡§™ ‡§™‡•ç‡§≤‡•Ö‡§®‡§∞',
                'nav-festivals': '‡§™‡§∞‡•ç‡§Ø‡§ü‡§® ‡§∏‡•ç‡§•‡§≥ ‡§∂‡•ã‡§ß‡§ï',
                'search-placeholder': '‡§≠‡§æ‡§∞‡§§‡§æ‡§§‡•Ä‡§≤ ‡§ï‡•ã‡§£‡§§‡•ç‡§Ø‡§æ‡§π‡•Ä ‡§∏‡•ç‡§•‡§æ‡§®‡§æ‡§∏‡§æ‡§†‡•Ä ‡§∂‡•ã‡§ß‡§æ...',
                'btn-fun-fact': '‡§Æ‡§ú‡•á‡§¶‡§æ‡§∞ ‡§§‡§•‡•ç‡§Ø',
                'btn-architecture': '‡§µ‡§æ‡¥∏‡µç‡¥§‡µÅ‡§∂‡§æ‡§∏‡•ç‡§§‡•ç‡§∞',
                'btn-why-famous': '‡§ï‡§æ ‡§™‡•ç‡§∞‡§∏‡§ø‡§¶‡•ç‡§ß?',
                'weather-title': '‡§∏‡§ß‡•ç‡§Ø‡§æ‡§ö‡•á ‡§π‡§µ‡§æ‡§Æ‡§æ‡§®',
                'weather-loading': '‡§≤‡•ã‡§° ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...',
                'weather-error': '‡§≤‡•ã‡§° ‡§ï‡§∞‡•Ç ‡§∂‡§ï‡§≤‡•ã ‡§®‡§æ‡§π‡•Ä.',
                'ai-thinking': '‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...',
                'ai-history-generating': '‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...',
                'ai-error': '‡§â‡§§‡•ç‡§§‡§∞ ‡§Æ‡§ø‡§≥‡•Ç ‡§∂‡§ï‡§≤‡•á ‡§®‡§æ‡§π‡•Ä.',
                'title-map': 'AI-‡§∂‡§ï‡•ç‡§§‡•Ä‡§ö‡§æ ‡§®‡§ï‡§æ‡§∂‡§æ | ‡§Ö‡§§‡•Å‡§≤‡•ç‡§Ø ‡§≠‡§æ‡§∞‡§§'
              }
            };

            const languageSelect = document.getElementById('language-select');

            const updateContent = (lang) => {
                const currentTranslations = translations[lang];
                if (!currentTranslations) return; // Exit if language not found

                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (currentTranslations[key]) {
                        element.textContent = currentTranslations[key];
                    }
                });

                document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-i18n-placeholder');
                    if (currentTranslations[key]) {
                        element.placeholder = currentTranslations[key];
                    }
                });

                document.title = currentTranslations['title-map'];
            };

            languageSelect.addEventListener('change', (e) => {
                updateContent(e.target.value);
                // If details panel is open, re-fetch data in the new language
                if (detailsPanel.classList.contains('visible')) {
                    const locationName = document.getElementById('panel-title').textContent;
                    if(locationName && locationName !== 'Location Title') { // Check if a location is loaded
                        generateHistory(locationName); // Re-fetch history
                        getWeather(locationName); // Re-fetch weather
                    }
                }
            });

            updateContent('en'); // Set initial language
            // --- END TRANSLATION SCRIPT ---


            const map = L.map("map", { zoomControl: false }).setView([22.5937, 78.9629], 5);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const menuToggle = document.getElementById('menu-toggle');
            const navLinks = document.getElementById('nav-links');
            menuToggle.addEventListener('click', () => {
                navLinks.classList.toggle('show');
                menuToggle.classList.toggle('active'); // Toggle active class for animation
            });

            let temporaryMarker = null;
            const detailsPanel = document.getElementById('details-panel');
            const descriptionEl = document.getElementById('panel-description');
            let typeInterval;

            function typewriterEffect(element, text, speed = 20) {
                clearInterval(typeInterval);
                if (typeof text !== 'string') {
                    console.error("Invalid text passed to typewriterEffect:", text);
                    element.textContent = (translations[languageSelect.value] || translations.en)['ai-error'];
                    return;
                }
                let cleanedText = text.replace(/\*\*/g, '');
                element.innerHTML = '';
                let i = 0;
                const cursor = document.createElement('span');
                cursor.className = 'blinking-cursor';
                cursor.textContent = '_';
                element.appendChild(cursor);

                typeInterval = setInterval(() => {
                    if (i < cleanedText.length) {
                        element.insertBefore(document.createTextNode(cleanedText.charAt(i)), cursor);
                        i++;
                    } else {
                        cursor.remove();
                        clearInterval(typeInterval);
                    }
                }, speed);
            }


            const getWeather = async (locationName) => {
                const selectedLang = languageSelect.value;
                const currentTranslations = translations[selectedLang] || translations.en;

                const weatherDescEl = document.getElementById('weather-desc');
                const climateTipsList = document.getElementById('climate-tips-list');
                const weatherTempEl = document.getElementById('weather-temp');

                weatherDescEl.textContent = currentTranslations['weather-loading'];
                weatherTempEl.textContent = '--¬∞C';
                climateTipsList.innerHTML = '';

                try {
                    const response = await fetch(`${backendUrl}/api/map/weather`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ locationName, language: selectedLang })
                    });
                    const data = await response.json();

                    if (response.ok && data) { // Check if data is received
                        weatherTempEl.textContent = `${Math.round(data.temp)}¬∞C`;
                        weatherDescEl.textContent = data.description;

                        if (data.tips && Array.isArray(data.tips)) {
                            if (data.tips.length > 0) {
                                data.tips.forEach(tip => {
                                    const li = document.createElement('li');
                                    li.textContent = tip;
                                    climateTipsList.appendChild(li);
                                });
                            } else {
                                // Handle case where tips array is empty
                                climateTipsList.innerHTML = `<li>No specific tips available.</li>`; // Needs translation
                            }
                        } else {
                             // Handle case where tips array is missing
                            console.warn("Weather tips missing from API response:", data);
                            climateTipsList.innerHTML = `<li>${currentTranslations['ai-error'] || 'Tips unavailable.'}</li>`;
                        }
                    } else {
                         weatherDescEl.textContent = currentTranslations['weather-error'];
                         console.error("Weather API Error Response:", data);
                    }
                } catch (error) {
                    console.error("Failed to fetch weather:", error);
                    weatherDescEl.textContent = currentTranslations['weather-error'];
                }
            };

            const showDetails = (location) => {
                if (!location || !location.name) {
                    console.error("Invalid location data passed to showDetails");
                    return;
                }
                document.getElementById('panel-title').textContent = location.name;
                generateHistory(location.name);
                getWeather(location.name);
                detailsPanel.classList.add('visible');
            };
            document.getElementById('close-btn').addEventListener('click', () => detailsPanel.classList.remove('visible'));

            const queryAI = async (locationName, question) => {
                const selectedLang = languageSelect.value;
                const currentTranslations = translations[selectedLang] || translations.en;

                descriptionEl.innerHTML = currentTranslations['ai-thinking'] + '<span class="blinking-cursor">_</span>';
                try {
                    const response = await fetch(`${backendUrl}/api/map/query`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ locationName, question, language: selectedLang })
                    });
                     if (!response.ok) {
                         const errorData = await response.json().catch(() => ({ message: `API responded with status ${response.status}` }));
                         throw new Error(errorData.message || `API responded with status ${response.status}`);
                     }
                    const data = await response.json();
                     if (!data || typeof data.answer !== 'string') { // Check type of answer
                         throw new Error("Invalid or missing 'answer' in AI response");
                     }
                    typewriterEffect(descriptionEl, data.answer);
                } catch (error) {
                     console.error("Error during AI query:", error);
                    descriptionEl.textContent = currentTranslations['ai-error'];
                }
            };

            const generateHistory = async (locationName) => {
                const selectedLang = languageSelect.value;
                const currentTranslations = translations[selectedLang] || translations.en;

                descriptionEl.innerHTML = currentTranslations['ai-history-generating'] + '<span class="blinking-cursor">_</span>';
                try {
                     const response = await fetch(`${backendUrl}/api/map/history`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ locationName, language: selectedLang })
                    });
                     if (!response.ok) {
                          const errorData = await response.json().catch(() => ({ message: `API responded with status ${response.status}` }));
                         throw new Error(errorData.message || `API responded with status ${response.status}`);
                     }
                    const data = await response.json();
                     if (!data || typeof data.history !== 'string') { // Check type of history
                          throw new Error("Invalid or missing 'history' in AI response");
                     }
                    typewriterEffect(descriptionEl, data.history);
                } catch (error) {
                     console.error("Error during history generation:", error);
                    descriptionEl.textContent = currentTranslations['ai-error'];
                }
            };

            document.querySelector('.ai-buttons').addEventListener('click', (e) => {
                if(e.target.classList.contains('ai-btn')) {
                    const locationName = document.getElementById('panel-title').textContent;
                    if (locationName && locationName !== 'Location Title') { // Check default title
                         const question = e.target.dataset.question;
                         queryAI(locationName, question);
                    } else {
                         console.warn("No location selected in the panel to query about.");
                    }
                }
            });

            const searchInput = document.getElementById('search-input');
            const searchSpinner = document.getElementById('search-spinner');
            let searchTimeout;

            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    const query = searchInput.value;
                    if (query.length < 3) return;

                    searchSpinner.style.display = 'block';
                    try {
                        const response = await fetch(`${backendUrl}/api/map/search`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query })
                        });
                        if (!response.ok) {
                            throw new Error(`Search API failed with status ${response.status}`);
                        }
                        const matchedLocations = await response.json();

                        if (matchedLocations && matchedLocations.length > 0) {
                            const loc = matchedLocations[0];
                            if (typeof loc.lat === 'number' && typeof loc.lon === 'number' && loc.name) { // Also check name
                                if (temporaryMarker) {
                                    map.removeLayer(temporaryMarker);
                                }
                                temporaryMarker = L.marker([loc.lat, loc.lon]).addTo(map);
                                showDetails(loc); // Opens panel and fetches AI data
                                map.flyTo([loc.lat, loc.lon], 13, { animate: true, duration: 1.5 });
                             } else {
                                 console.warn("Search result missing valid coordinates or name:", loc);
                             }
                        } else {
                             console.log("No locations found for query:", query);
                             // Optionally provide user feedback (e.g., clear panel, show message)
                             detailsPanel.classList.remove('visible'); // Close panel if nothing found
                             if (temporaryMarker) map.removeLayer(temporaryMarker); // Remove old marker
                        }
                    } catch (error) {
                        console.error("Search failed:", error);
                         // Optionally provide user feedback about the error
                         alert("Search failed. Please try again later."); // Simple alert
                    } finally {
                        searchSpinner.style.display = 'none';
                    }
                }, 1000); // 1-second debounce
            });
        });
    </script>
</body>
</html>
